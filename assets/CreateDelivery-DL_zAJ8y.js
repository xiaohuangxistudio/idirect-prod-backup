import{_ as Q,T as A,n as I,m as b,h,p as R,q as B,c as g,a as s,b as r,w as l,r as a,o as p,f as c,F as S,e as T,t as f,g as C,d as P,v as z}from"./index-Cm55Gr8Q.js";const E={name:"MerchantCreateDelivery",components:{[A.name]:A},setup(){const t=new Date,e=I([t.getFullYear().toString(),(t.getMonth()+1).toString().padStart(2,"0"),t.getDate().toString().padStart(2,"0")]),d=new Date(t.getTime());d.setHours(d.getHours()+1);const i=I([d.getHours().toString().padStart(2,"0"),d.getMinutes().toString().padStart(2,"0")]);return{currentDate:e,currentTime:i}},data(){return{form:{merchantName:"",merchantPhone:"",merchantAddress:"",customerName:"",customerPhone:"",customerAddress:"",merchantRemark:"",customerRemark:"",deliveryTimeOption:"ASAP",deliveryTime:null,quoteUniqueId:""},shops:[],selectedShopId:null,showShopPopup:!1,isManualInput:!1,distanceText:"",durationText:"",quoteFee:null,canDelivery:null,canDeliveryReason:"",isQuoteObtained:!1,quoteLoading:!1,submitLoading:!1,selectedTime:["12","00"],showTimePicker:!1,feeBreakdown:[],totalFee:null}},created(){this.fetchMerchantInfo()},mounted(){this.initAutocomplete()},methods:{goBack(){this.$router.push("/merchant/home")},initAutocomplete(){const t={north:-33.5,south:-34,east:151.5,west:150.5},e=this.$refs.merchantAddressInput.$el.querySelector("input");if(e){const i=new google.maps.places.Autocomplete(e,{bounds:t,componentRestrictions:{country:"au"},fields:["address_components","formatted_address","geometry"]});i.addListener("place_changed",()=>{const n=i.getPlace();this.form.merchantAddress=n.formatted_address||"",console.log("Selected Merchant Address:",this.form.merchantAddress)})}const d=this.$refs.customerAddressInput.$el.querySelector("input");if(d){const i=new google.maps.places.Autocomplete(d,{bounds:t,componentRestrictions:{country:"au"},fields:["address_components","formatted_address","geometry"]});i.addListener("place_changed",()=>{const n=i.getPlace();this.form.customerAddress=n.formatted_address||"",console.log("Selected Customer Address:",this.form.customerAddress)})}},onAddressChange(){this.isQuoteObtained=!1},onTimeConfirm(t){try{const[e,d]=t,i=e.selectedValues.join("-"),n=d.selectedValues.join(":");this.form.deliveryTime=`${i} ${n}`,console.log("Formatted delivery time:",this.form.deliveryTime)}catch(e){console.error("Error formatting delivery time:",e),this.form.deliveryTime=null}finally{this.showTimePicker=!1}},showShopPopupWindow(){this.showShopPopup=!0},async fetchMerchantInfo(){try{const t=await b.get("/api/merchant/getMyShopsV1");if(t.data.code===200){const e=t.data.data.staticImageCdn;this.shops=t.data.data.shopInfo.map(d=>({...d,fullLogoUrl:e+d.logo}))}else h(t.data.message||"加载商家信息失败")}catch(t){console.error("Fetch merchant info error:",t),h("网络错误，无法加载商家信息")}console.log(this.shops)},selectManualInput(){this.isManualInput=!0,this.showShopPopup=!1},selectShop(t){this.selectedShopId=t.id,this.form.merchantName=t.name,this.form.merchantPhone=t.phone,this.form.merchantAddress=t.houseNumber+" "+t.address,this.showShopPopup=!1,this.isManualInput=!1,this.isQuoteObtained=!1},async submitForm(){if(this.isQuoteObtained){this.submitLoading=!0;try{const t=await b.post("/api/merchant/submitDelivery",this.form);if(console.log("Form submitted:",t.data),t.data.code===200){R({message:t.data.msg||"表单提交成功",duration:3e3});const e=t.data.data.deliveryId;this.$router.push({path:"/merchant/track-delivery",query:{deliveryId:e}})}else h({message:t.data.msg||"提交失败，请稍后再试",duration:3e3})}catch(t){console.log(t),h({message:"提交失败"+t,duration:3e3})}finally{this.submitLoading=!1}}},resetForm(){this.isQuoteObtained=!1,this.$refs.form.resetFields()},async getQuote(){this.quoteLoading=!0;try{const t=await b.post("/api/Merchant/getDeliveryQuote",{merchantAddress:this.form.merchantAddress,customerAddress:this.form.customerAddress});if(t.data.code===200){const e=t.data.data;this.form.quoteUniqueId=e.quoteUniqueId,this.feeBreakdown=e.feeBreakdown,this.totalFee=e.quoteAmount,this.isQuoteObtained=!0}else h({message:t.data.message||"报价获取失败"})}catch(t){console.error("Error fetching quote:",t),h({message:"服务器异常"})}finally{this.quoteLoading=!1}},showDescribe(t){B({message:t})},resetQuoteData(){this.distanceText="",this.durationText="",this.quoteFee=null,this.canDelivery=null,this.canDeliveryReason="",this.isQuoteObtained=!1}}},H={class:"page"},Y={class:"create-delivery-form"},j={class:"form-group"},W={class:"popup-content"},G={class:"manual-input-option"},J={class:"shop-list"},K={class:"shop-info"},X={class:"shop-name"},Z={class:"shop-address"},$={class:"shop-phone"},ee={class:"form-group",style:{"margin-top":"15px"}},oe={style:{"padding-top":"15px"}},te={class:"fee-label"},ne={class:"total-fee"},se={class:"button-container"};function re(t,e,d,i,n,m){const q=a("van-nav-bar"),u=a("van-field"),v=a("van-button"),x=a("van-loading"),D=a("van-image"),y=a("van-icon"),k=a("van-popup"),_=a("van-cell-group"),w=a("van-radio"),F=a("van-radio-group"),M=a("van-date-picker"),U=a("van-time-picker"),L=a("van-picker-group"),N=a("van-form"),O=a("el-card");return p(),g("div",H,[s(q,{title:"创建配送订单","left-arrow":"",fixed:"",onClickLeft:m.goBack},null,8,["onClickLeft"]),r("div",Y,[s(N,{onSubmit:m.submitForm},{default:l(()=>[r("div",j,[s(_,null,{default:l(()=>[s(u,{label:"选择商家",placeholder:"请选择商家","is-link":"",readonly:"",onClick:m.showShopPopupWindow},null,8,["onClick"]),s(k,{show:n.showShopPopup,"onUpdate:show":e[0]||(e[0]=o=>n.showShopPopup=o),position:"bottom",round:"",style:{height:"80vh"}},{default:l(()=>[r("div",W,[e[18]||(e[18]=r("h3",null,"请选择店铺",-1)),r("div",G,[s(v,{size:"large",type:"info",plain:"",block:"",onClick:m.selectManualInput},{default:l(()=>e[16]||(e[16]=[c(" 手动输入 ")])),_:1},8,["onClick"])]),r("div",J,[(p(!0),g(S,null,T(n.shops,o=>(p(),g("div",{key:o.id,class:"shop-item"},[s(D,{class:"shop-logo",src:o.fullLogoUrl,radius:"8px",alt:"店铺Logo"},{loading:l(()=>[s(x,{type:"spinner",size:"20"})]),_:2},1032,["src"]),r("div",K,[r("div",X,[s(y,{name:"shop-o",size:"18px"}),c(" "+f(o.name),1)]),r("div",Z,[s(y,{name:"location-o",size:"16px"}),c(" "+f(o.houseNumber+" "+o.address),1)]),r("div",$,[s(y,{name:"phone-o",size:"16px"}),c(" "+f(o.phone),1)])]),s(v,{size:"small",type:"primary",plain:"",onClick:V=>m.selectShop(o)},{default:l(()=>e[17]||(e[17]=[c(" 选择 ")])),_:2},1032,["onClick"])]))),128))])])]),_:1},8,["show"]),s(u,{modelValue:n.form.merchantName,"onUpdate:modelValue":e[1]||(e[1]=o=>n.form.merchantName=o),label:"商家名称",readonly:!n.isManualInput,placeholder:"请输入商家名称",required:""},null,8,["modelValue","readonly"]),s(u,{modelValue:n.form.merchantPhone,"onUpdate:modelValue":e[2]||(e[2]=o=>n.form.merchantPhone=o),label:"商家电话",readonly:!n.isManualInput,placeholder:"请输入商家电话",type:"number",required:""},null,8,["modelValue","readonly"]),s(u,{modelValue:n.form.merchantAddress,"onUpdate:modelValue":e[3]||(e[3]=o=>n.form.merchantAddress=o),label:"商家地址",readonly:!n.isManualInput,placeholder:"请输入商家地址",required:"",ref:"merchantAddressInput",onInput:m.onAddressChange},null,8,["modelValue","readonly","onInput"]),s(u,{modelValue:n.form.merchantRemark,"onUpdate:modelValue":e[4]||(e[4]=o=>n.form.merchantRemark=o),label:"备注",type:"textarea",rows:"2",placeholder:"商家备注"},null,8,["modelValue"])]),_:1})]),r("div",ee,[s(_,null,{default:l(()=>[s(u,{modelValue:n.form.customerName,"onUpdate:modelValue":e[5]||(e[5]=o=>n.form.customerName=o),label:"客户名称",placeholder:"请输入客户名称",required:""},null,8,["modelValue"]),s(u,{modelValue:n.form.customerPhone,"onUpdate:modelValue":e[6]||(e[6]=o=>n.form.customerPhone=o),label:"客户电话",placeholder:"请输入客户电话",type:"number",required:""},null,8,["modelValue"]),s(u,{modelValue:n.form.customerAddress,"onUpdate:modelValue":e[7]||(e[7]=o=>n.form.customerAddress=o),label:"客户地址",placeholder:"请输入客户地址",required:"",ref:"customerAddressInput",onInput:m.onAddressChange},null,8,["modelValue","onInput"]),s(u,{modelValue:n.form.customerRemark,"onUpdate:modelValue":e[8]||(e[8]=o=>n.form.customerRemark=o),label:"备注",type:"textarea",rows:"2",placeholder:"客户备注"},null,8,["modelValue"]),s(u,{name:"radio",label:"配送时间",required:""},{input:l(()=>[s(F,{modelValue:n.form.deliveryTimeOption,"onUpdate:modelValue":e[9]||(e[9]=o=>n.form.deliveryTimeOption=o),direction:"horizontal"},{default:l(()=>[s(w,{name:"ASAP"},{default:l(()=>e[19]||(e[19]=[c("尽快")])),_:1}),s(w,{name:"SPECIFY_TIME"},{default:l(()=>e[20]||(e[20]=[c("指定时间")])),_:1})]),_:1},8,["modelValue"])]),_:1}),n.form.deliveryTimeOption==="SPECIFY_TIME"?(p(),C(u,{key:0,modelValue:n.form.deliveryTime,"onUpdate:modelValue":e[10]||(e[10]=o=>n.form.deliveryTime=o),label:"送达时间",placeholder:"选择时间",readonly:"",clickable:"",onClick:e[11]||(e[11]=o=>n.showTimePicker=!0)},null,8,["modelValue"])):P("",!0),s(k,{show:n.showTimePicker,"onUpdate:show":e[15]||(e[15]=o=>n.showTimePicker=o),position:"bottom"},{default:l(()=>[s(L,{title:"选择预计送达时间",tabs:["选择日期","选择时间"],"next-step-text":"下一步",onConfirm:m.onTimeConfirm,onCancel:e[14]||(e[14]=o=>n.showTimePicker=!1)},{default:l(()=>[s(M,{modelValue:i.currentDate,"onUpdate:modelValue":e[12]||(e[12]=o=>i.currentDate=o),"min-date":t.minDate,"max-date":t.maxDate},null,8,["modelValue","min-date","max-date"]),s(U,{modelValue:i.currentTime,"onUpdate:modelValue":e[13]||(e[13]=o=>i.currentTime=o)},null,8,["modelValue"])]),_:1},8,["onConfirm"])]),_:1},8,["show"])]),_:1})])]),_:1},8,["onSubmit"]),r("div",oe,[s(_,null,{default:l(()=>[s(O,null,{default:l(()=>[(p(!0),g(S,null,T(n.feeBreakdown,(o,V)=>(p(),g("div",{key:V,class:"fee-item"},[r("div",te,[r("span",null,f(o.type),1),o.describe?(p(),C(y,{key:0,name:"question-o",size:"16px",class:"info-icon",onClick:le=>m.showDescribe(o.describe)},null,8,["onClick"])):P("",!0)]),r("div",{class:"fee-amount",style:z({color:o.amount<0?"rgb(242, 83, 83)":"#333"})},f(o.amount===0?"免费":o.amount<0?"-$"+Math.abs(o.amount/100).toFixed(2):"$"+(o.amount/100).toFixed(2)),5)]))),128)),r("div",ne,[e[21]||(e[21]=r("strong",null,"总计：",-1)),r("span",null,f("$"+(n.totalFee/100).toFixed(2)),1)])]),_:1})]),_:1})]),r("div",se,[s(v,{type:"primary",block:"",onClick:m.getQuote,loading:n.quoteLoading},{default:l(()=>e[22]||(e[22]=[c(" 获取报价 ")])),_:1},8,["onClick","loading"]),s(v,{type:"primary",block:"",onClick:m.submitForm,loading:n.submitLoading,disabled:!n.isQuoteObtained},{default:l(()=>e[23]||(e[23]=[c(" 确认提交 ")])),_:1},8,["onClick","loading","disabled"])])])])}const ie=Q(E,[["render",re],["__scopeId","data-v-fed0e537"]]);export{ie as default};
