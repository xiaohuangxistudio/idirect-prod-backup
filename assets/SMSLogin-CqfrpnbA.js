import k from"./Captcha-CLkH83mj.js";import{_ as T,h as m,x as p,m as g,p as f,s as C,u as w,c as x,a,b as r,w as d,r as l,o as y,f as v,t as B}from"./index-Cm55Gr8Q.js";const L={name:"MerchantSmsLogin",components:{Captcha:k},data(){return{form:{username:"",smsCode:"",captcha:""},errorMessage:{username:"",smsCode:"",captcha:""},isSending:!1,smsButtonText:"发送验证码",smsCountdown:60}},methods:{validateUsername(){this.errorMessage.username=this.form.username?"":"用户名不能为空"},validateSmsCode(){this.errorMessage.smsCode=this.form.smsCode?"":"短信验证码不能为空"},validateCaptcha(){this.errorMessage.captcha=this.form.captcha?"":"请完成行为验证码"},async sendSmsCode(){if(!this.form.username){m("请输入用户名");return}try{this.isSending=!0,p({message:"发送中...",forbidClick:!0});const t=await g.post("/api/merchant/sendSmsByUsernameV1",{username:this.form.username});t.data.code===200?(f("验证码已发送"),this.startCountdown()):(this.isSending=!1,C(t.data.message||"验证码发送失败"))}catch(t){this.isSending=!1,C("网络错误，请稍后重试"),console.error("发送验证码错误:",t)}},startCountdown(){this.smsCountdown=60,this.smsButtonText=`${this.smsCountdown}s`,this.isSending=!0;const t=setInterval(()=>{this.smsCountdown--,this.smsCountdown<=0?(clearInterval(t),this.smsButtonText="发送验证码",this.isSending=!1):this.smsButtonText=`${this.smsCountdown}s`},1e3)},async handleSubmit(){var t,e;if(!this.form.username||!this.form.smsCode){m("请输入用户名和短信验证码");return}try{p({message:"加载中...",forbidClick:!0});const i=await this.$refs.captchaComponent.validateCaptcha();if(!i){this.$refs.captchaComponent.refreshCaptcha(),console.error("验证码验证失败");return}this.form.captcha=i;const o=await g.post("/api/merchant/smsLoginV1",this.form);if(console.log("Login.vue response:",o.data),o.data.code===200)w().setToken(o.data.data.token),console.log("登录获取到JWT Token: "+o.data.data.token),f("登录成功"),this.$refs.captchaComponent.refreshCaptcha(),this.$router.push("/merchant/home");else{const s=o.data.message||"登录失败";m(s),this.$refs.captchaComponent.refreshCaptcha(),console.error("Login.vue 登录失败：",s)}}catch(i){const o=((e=(t=i.response)==null?void 0:t.data)==null?void 0:e.message)||"网络错误";m(o),this.$refs.captchaComponent.refreshCaptcha(),console.error("Login.vue 登录失败：",o)}},goToLogin(){this.$router.push("/merchant/login")},goToRegister(){this.$router.push("/merchant/register")}}},V={class:"page"},M={class:"form"},D={class:"button-container"};function R(t,e,i,o,s,n){const _=l("van-nav-bar"),h=l("van-field"),u=l("van-button"),S=l("Captcha"),b=l("van-cell-group");return y(),x("div",V,[a(_,{title:"短信登录","right-text":"注册",onClickRight:n.goToRegister},null,8,["onClickRight"]),e[4]||(e[4]=r("div",{class:"logo-container"},[r("img",{src:"https://delivery-static-file.idirect.au/asset/image/iDirect-home-logo-black_512x128.png",alt:"iDirect Logo",class:"logo-image"})],-1)),e[5]||(e[5]=r("div",{class:"logo-description-container"},[r("img",{src:"https://delivery-static-file.idirect.au/asset/image/iDirect-home-desc_520x60.png",alt:"iDirect Discription",class:"logo-description-image"})],-1)),r("div",M,[a(b,{inset:""},{default:d(()=>[a(h,{modelValue:s.form.username,"onUpdate:modelValue":e[0]||(e[0]=c=>s.form.username=c),label:"用户名",placeholder:"请输入用户名",clearable:"",required:"","error-message":s.errorMessage.username,onBlur:n.validateUsername},null,8,["modelValue","error-message","onBlur"]),a(h,{modelValue:s.form.smsCode,"onUpdate:modelValue":e[1]||(e[1]=c=>s.form.smsCode=c),label:"短信验证码",placeholder:"请输入短信验证码",clearable:"",type:"digit",required:"","error-message":s.errorMessage.smsCode},{button:d(()=>[a(u,{size:"small",type:"primary",disabled:s.isSending,onClick:n.sendSmsCode},{default:d(()=>[v(B(s.smsButtonText),1)]),_:1},8,["disabled","onClick"])]),_:1},8,["modelValue","error-message"]),a(S,{ref:"captchaComponent"},null,512)]),_:1}),r("div",D,[a(u,{type:"primary",block:"",onClick:n.handleSubmit},{default:d(()=>e[3]||(e[3]=[v(" 登录 ")])),_:1},8,["onClick"])]),r("div",{class:"login-link",onClick:e[2]||(e[2]=(...c)=>n.goToLogin&&n.goToLogin(...c))}," 使用用户名密码登录 ")])])}const N=T(L,[["render",R],["__scopeId","data-v-64c17475"]]);export{N as default};
