import{_ as y,m as h,h as g,s as d,x as w,p as V,c as f,d as C,a as r,b as I,w as c,r as p,o as b,f as L}from"./index-Cm55Gr8Q.js";const k={name:"MerchantEditShop",data(){return{isLoading:!1,shopInfo:{id:null,name:"",address:"",houseNumber:"",phone:"",previewImages:[],submitImages:[]},errorMessage:{phone:""},autocomplete:null}},async created(){const o=this.$route.query.id;o&&await this.fetchShopInfo(o)},mounted(){this.$nextTick(()=>{this.initializeAutocomplete()})},methods:{goBack(){this.$router.push("/merchant/my-shop")},async fetchShopInfo(o){try{const e=await h.get(`/api/merchant/getMyShopsV1?shopId=${o}`);if(e.data.code===200){const s=e.data.data.shopInfo,i=e.data.data.staticImageCdn;console.log(s),this.shopInfo={id:s.id,name:s.name,address:s.address,houseNumber:s.houseNumber||"",phone:s.phone,previewImages:s.logo?[{url:`${i}${s.logo}`}]:[],submitImages:s.logo?[{uri:s.logo}]:[]}}else this.isLoading=!0,g({message:e.data.message||"加载商店信息失败",duration:5e3,onClose:()=>{this.isLoading=!1,this.$router.push("/merchant/my-shop")}})}catch(e){this.isLoading=!0,g({message:"网络错误",duration:5e3,onClose:()=>{this.isLoading=!1,this.$router.push("/merchant/my-shop")}}),console.error("Fetch shop info error:",e)}},initializeAutocomplete(){var o,e;if(!this.autocomplete&&window.google){const s=(e=(o=this.$refs.addressField)==null?void 0:o.$el)==null?void 0:e.querySelector("input");s?(this.autocomplete=new google.maps.places.Autocomplete(s,{componentRestrictions:{country:"au"},fields:["formatted_address","name"],types:["establishment","geocode"]}),this.autocomplete.addListener("place_changed",this.handlePlaceSelect)):console.error("地址输入框未正确挂载")}else window.google||console.error("Google Maps 未加载")},handlePlaceSelect(){const o=this.autocomplete.getPlace();o&&o.formatted_address?this.shopInfo.address=o.formatted_address:d("无法获取有效地址")},validatePhone(){const o=/^0\d{9}$/;this.errorMessage.phone=o.test(this.shopInfo.phone)?"":"请输入有效的澳大利亚手机号"},async onUpload(o){o.status="uploading",o.message="上传中...";try{const e=new FormData;e.append("file",o.file);const s=await h.post("/api/merchant/uploadFile",e,{headers:{"Content-Type":"multipart/form-data"}});if(s.data.code===200){const{url:i,uri:a}=s.data.data;o.status="done",o.message="上传成功",this.shopInfo.submitImages.push({url:i,uri:a}),d("图片上传成功")}else o.status="failed",o.message="上传失败",d(s.data.message||"图片上传失败")}catch(e){o.status="failed",o.message="上传失败",d(e.message),console.error("Image upload error:",e)}},onDelete(){return this.shopInfo.submitImages.pop(),!0},async onSave(){const{id:o,name:e,address:s,houseNumber:i,phone:a,submitImages:l}=this.shopInfo;if(this.validatePhone(),!e||!s||!a){d("请填写完整的商店信息");return}if(l.length===0){d("请上传商店Logo");return}const u={id:o,name:e,address:s,phone:a,houseNumber:i,images:l.map(t=>t.uri)};try{this.isLoading=!0,w({message:"保存中...",forbidClick:!0,loadingType:"spinner"});const t=await h.post("/api/merchant/editShop",u);if(t.data.code===200)V({message:"商店编辑成功",duration:3e3,onClose:()=>{this.$router.push("/merchant/my-shop")}});else{const m=t.data.error?`${t.data.message||"编辑商店失败"}: ${t.data.error}`:t.data.message||"编辑商店失败";d(m)}}catch(t){d("网络错误"),console.error("Edit shop error:",t)}}}},S={class:"page"},x={key:0,class:"overlay"},N={class:"tab-content"},T={class:"button-container"};function B(o,e,s,i,a,l){const u=p("van-nav-bar"),t=p("van-field"),m=p("van-uploader"),_=p("van-cell-group"),v=p("van-button");return b(),f("div",S,[a.isLoading?(b(),f("div",x)):C("",!0),r(u,{title:"编辑商店","left-text":"返回","left-arrow":"",onClickLeft:l.goBack},null,8,["onClickLeft"]),I("div",N,[r(_,{inset:""},{default:c(()=>[r(t,{modelValue:a.shopInfo.name,"onUpdate:modelValue":e[0]||(e[0]=n=>a.shopInfo.name=n),label:"名称",placeholder:"请输入商店名称",required:"",clearable:""},null,8,["modelValue"]),r(t,{modelValue:a.shopInfo.address,"onUpdate:modelValue":e[1]||(e[1]=n=>a.shopInfo.address=n),label:"地址",placeholder:"请输入商店地址",required:"",clearable:"",ref:"addressField"},null,8,["modelValue"]),r(t,{modelValue:a.shopInfo.houseNumber,"onUpdate:modelValue":e[2]||(e[2]=n=>a.shopInfo.houseNumber=n),label:"门牌号",placeholder:"请输入商店门牌号",clearable:""},null,8,["modelValue"]),r(t,{modelValue:a.shopInfo.phone,"onUpdate:modelValue":e[3]||(e[3]=n=>a.shopInfo.phone=n),label:"电话",placeholder:"请输入商店电话",required:"",clearable:"","error-message":a.errorMessage.phone,onBlur:l.validatePhone},null,8,["modelValue","error-message","onBlur"]),r(t,{label:"Logo",required:""},{input:c(()=>[r(m,{"result-type":"file","after-read":l.onUpload,"before-delete":l.onDelete,name:"file","max-count":"1",accept:"image/*",modelValue:a.shopInfo.previewImages,"onUpdate:modelValue":e[4]||(e[4]=n=>a.shopInfo.previewImages=n)},null,8,["after-read","before-delete","modelValue"])]),_:1})]),_:1}),I("div",T,[r(v,{type:"primary",block:"",round:"",onClick:l.onSave},{default:c(()=>e[5]||(e[5]=[L("保存修改")])),_:1},8,["onClick"])])])])}const U=y(k,[["render",B],["__scopeId","data-v-b97293ae"]]);export{U as default};
