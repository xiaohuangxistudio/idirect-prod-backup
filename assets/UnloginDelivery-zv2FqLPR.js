import{a as m}from"./axios-CwEm3LtT.js";import{_ as L,h as n,s as I,c as u,a,b as o,d as g,f as s,t as r,w as v,r as h,o as f}from"./index-Cm55Gr8Q.js";const C={data(){return{formData:{name:"",phone:""},currentLocation:{latitude:null,longitude:null},deliveryId:null,map:null,markerMerchant:null,markerCustomer:null,deliveryInfo:{},orderStatus:null,driverDirection:null,showConfirmDialog:!1,showPickupDialog:!1,showDropoffDialog:!1,directionsService:null,directionsRenderer:null,previewImages:[],submitImages:[],uploading:!1,mapInitialized:!1}},async mounted(){if(this.deliveryId=this.$route.query.deliveryId,!this.deliveryId){n("配送订单号缺失");return}this.monitorLocationPermission(),this.startGpsTracking(),this.fetchOrderInfo(),this.startDeliveryInfoRefresh()},methods:{async fetchOrderInfo(){try{const t=await m.get("/api/unlogin_driver/getDeliveryInfoV2",{params:{deliveryId:this.deliveryId}});if(t.data.code===200){const e=t.data.data;console.log(e),this.deliveryInfo={pickupAddress:e.pickupAddress,dropoffAddress:e.dropoffAddress,totalFee:e.totalFee,estimatedArrival:e.estimatedArrival,pickupLocation:e.pickupLocation,dropoffLocation:e.dropoffLocation,driverDirection:e.driverDirection,pickupPhone:e.pickupPhone,dropoffPhone:e.dropoffPhone},this.orderStatus=e.status,this.mapInitialized||(this.orderStatus==="REVIEW_SUCCESS"||this.orderStatus==="IN_DELIVERY"||this.orderStatus==="FINISH")&&this.$nextTick(()=>{this.initMap(),this.drawRoute(),this.mapInitialized=!0}),this.orderStatus==="FINISH"&&this.stopGpsTracking()}else n(t.data.message||"获取配送信息失败")}catch(t){console.error("Error fetching delivery info:",t),n("无法获取配送信息，请稍后重试")}},async monitorLocationPermission(){try{const t=await navigator.permissions.query({name:"geolocation"});console.log(`初始权限状态: ${t.state}`),t.onchange=()=>{console.log(`权限状态变更为: ${t.state}`),t.state==="granted"?this.checkGeolocationAccess():t.state==="denied"&&this.promptUserForLocationPermission()},t.state==="granted"?this.checkGeolocationAccess():t.state==="denied"&&this.promptUserForLocationPermission()}catch(t){console.error("无法检查权限:",t)}},checkGeolocationAccess(){navigator.geolocation.getCurrentPosition(t=>{console.log("当前位置:",t.coords)},t=>{console.error("获取地理位置失败:",t.message)})},promptUserForLocationPermission(){alert("位置权限已被拒绝，请在浏览器设置中启用位置权限以获取完整功能。")},getNavigationUrl(t){return!t||!t.lat||!t.lng?"#":`https://www.google.com/maps/dir/?api=1&destination=${t.lat},${t.lng}`},initMap(){const t=[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]}];this.map=new google.maps.Map(document.getElementById("map"),{center:{lat:parseFloat(this.deliveryInfo.pickupLocation.lat),lng:parseFloat(this.deliveryInfo.pickupLocation.lng)},zoom:14,disableDefaultUI:!0,mapTypeControl:!1,fullscreenControl:!1,styles:t}),this.markerMerchant=new google.maps.Marker({map:this.map,position:{lat:parseFloat(this.deliveryInfo.pickupLocation.lat),lng:parseFloat(this.deliveryInfo.pickupLocation.lng)},title:"商家地址",icon:"https://delivery-static-file.idirect.au/asset/icon/merchant.svg"}),this.markerCustomer=new google.maps.Marker({map:this.map,position:{lat:parseFloat(this.deliveryInfo.dropoffLocation.lat),lng:parseFloat(this.deliveryInfo.dropoffLocation.lng)},title:"客户地址",icon:"https://delivery-static-file.idirect.au/asset/icon/customer.svg"})},drawRoute(){this.directionsService||(this.directionsService=new google.maps.DirectionsService),this.directionsRenderer||(this.directionsRenderer=new google.maps.DirectionsRenderer({map:this.map,suppressMarkers:!0,polylineOptions:{strokeColor:"#4285F4",strokeWeight:6}}));const t={origin:{lat:parseFloat(this.deliveryInfo.pickupLocation.lat),lng:parseFloat(this.deliveryInfo.pickupLocation.lng)},destination:{lat:parseFloat(this.deliveryInfo.dropoffLocation.lat),lng:parseFloat(this.deliveryInfo.dropoffLocation.lng)},travelMode:google.maps.TravelMode.DRIVING};this.directionsService.route(t,(e,p)=>{if(p===google.maps.DirectionsStatus.OK){this.directionsRenderer.setDirections(e);const c=new google.maps.LatLngBounds;c.extend(this.markerMerchant.getPosition()),c.extend(this.markerCustomer.getPosition()),this.map.fitBounds(c)}else console.error("Directions request failed:",p)})},openConfirmDialog(){this.showConfirmDialog=!0},validateAustralianPhone(t){return/^(?:\+61|0)4\d{8}$/.test(t)},async confirmOrder(){if(!this.formData.name){n("姓名不能为空");return}if(!this.formData.phone){n("手机号不能为空");return}if(!this.validateAustralianPhone(this.formData.phone)){n("请输入有效的手机号");return}try{const t=await m.post("/api/unlogin_driver/acceptOrder",{deliveryId:this.deliveryId,name:this.formData.name,phone:this.formData.phone});t.data.code===200?(I("接单成功"),this.orderStatus="IN_DELIVERY",this.deliveryInfo.driverDirection="HEADING_TO_MERCHANT",this.showConfirmDialog=!1):n(t.data.message||"接单失败")}catch(t){console.error("Error confirming order:",t),n("接单失败，请稍后重试")}},openPickupDialog(){this.showPickupDialog=!0},openDropoffDialog(){this.showDropoffDialog=!0},async onUpload(t){this.uploading=!0,t.status="uploading",t.message="上传中...";const e=new FormData;e.append("deliveryId",this.deliveryId),e.append("file",t.file);try{const p=await m.post("/api/unlogin_driver/uploadFile",e,{headers:{"Content-Type":"multipart/form-data"}});p.data.code===200?(this.uploadedImageUri=p.data.data.uri,t.status="done",t.message="上传成功",I("图片上传成功")):(t.status="failed",t.message="上传失败",n(p.data.message||"图片上传失败"))}catch(p){t.status="failed",t.message="上传失败",console.error("Error uploading image:",p),n("图片上传失败，请稍后重试")}finally{this.uploading=!1}},async confirmPickup(){if(!this.uploadedImageUri){n("请先上传领取商品的图片");return}try{const t=await m.post("/api/unlogin_driver/confirmPickup",{deliveryId:this.deliveryId,pickedupImage:this.uploadedImageUri});t.data.code===200?(this.orderStatus="IN_DELIVERY",this.deliveryInfo.driverDirection="HEADING_TO_CUSTOMER",I("商品领取确认成功"),this.showPickupDialog=!1):n(t.data.message||"确认失败")}catch(t){console.error("Error confirming pickup:",t),n("确认失败，请稍后重试")}finally{this.previewImages=[],this.submitImages=[]}},async confirmDropoff(){if(!this.uploadedImageUri){n("请先送达商品的图片");return}try{const t=await m.post("/api/unlogin_driver/confirmDropoff",{deliveryId:this.deliveryId,dropoffedImage:this.uploadedImageUri});t.data.code===200?(this.orderStatus="FINISH",this.deliveryInfo.driverDirection=null,I("确认送达成功"),this.showDropoffDialog=!1):n(t.data.message||"确认失败")}catch(t){console.error("Error confirming dropoff:",t),n("确认失败，请稍后重试")}finally{this.previewImages=[],this.submitImages=[]}},async getCurrentLocation(){try{const t=await new Promise((p,c)=>{navigator.geolocation.getCurrentPosition(p,c,{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})});this.currentLocation.latitude=t.coords.latitude,this.currentLocation.longitude=t.coords.longitude;const e={lat:this.currentLocation.latitude,lng:this.currentLocation.longitude};return this.marker?(this.marker.setVisible(!1),this.marker.setPosition(e)):(this.marker=new google.maps.Marker({map:this.map,position:e}),this.marker.setVisible(!1)),this.errorMessage=null,e}catch(t){return this.errorMessage="无法获取当前位置，请检查设备定位权限。",console.error("Error getting location:",t),null}},async reportLocation(t){try{if(!t)return;const e=await m.post("/api/unlogin_driver/updateGpsSync",{deliveryId:this.deliveryId,latitude:t.lat,longitude:t.lng});e.data.code===200?console.log("位置上报成功:",e.data.message):console.error("位置上报失败:",e.data.message)}catch(e){console.error("Error reporting location:",e)}},async updateLocation(){const t=await this.getCurrentLocation();t&&await this.reportLocation(t)},startGpsTracking(){this.updateLocation(),this.GpsIntervalId=setInterval(()=>{this.updateLocation()},1e4)},stopGpsTracking(){this.GpsIntervalId&&(clearInterval(this.GpsIntervalId),this.GpsIntervalId=null)},startDeliveryInfoRefresh(){this.updateLocation(),this.deliveryIntervalId=setInterval(()=>{this.fetchOrderInfo()},1e4)},stopDeliveryInfoRefresh(){this.deliveryIntervalId&&(clearInterval(this.deliveryIntervalId),this.deliveryIntervalId=null)}}},P={class:"page"},S={class:"tab-content"},E={class:"info-overlay"},A={class:"scrollable"},F={key:0},U={class:"status-container"},R={key:1},V={class:"order-info"},N={class:"button-container"},T={key:2},G={key:0},M={class:"status-container"},x=["href"],O=["href"],H=["href"],q=["href"],B={class:"button-container"},W={key:1},Y={class:"status-container"},z=["href"],K=["href"],j=["href"],J=["href"],Q={class:"button-container"},X={key:3},Z={class:"status-container"},$={class:"dialog-content"},ee={class:"uploader-container"},oe={class:"dialog-content"},te={class:"uploader-container"};function ie(t,e,p,c,i,d){const _=h("van-nav-bar"),D=h("van-icon"),y=h("van-button"),w=h("van-field"),k=h("van-dialog"),b=h("van-uploader");return f(),u("div",P,[a(_,{fixed:"",title:"配送任务"}),o("div",S,[e[38]||(e[38]=o("div",{class:"map-wrapper"},[o("div",{id:"map",class:"map-container"})],-1)),o("div",E,[o("div",A,[i.orderStatus==="WAITING_PAY"||i.orderStatus==="WAITING_REVIEW"?(f(),u("div",F,[o("div",U,[a(D,{name:"close",class:"fail-icon"}),e[7]||(e[7]=o("h2",{class:"fail-word"},"订单暂不支持接单",-1))])])):g("",!0),i.orderStatus==="REVIEW_SUCCESS"?(f(),u("div",R,[o("div",V,[o("p",null,[e[8]||(e[8]=o("strong",null,"商家地址:",-1)),s(" "+r(i.deliveryInfo.pickupAddress),1)]),o("p",null,[e[9]||(e[9]=o("strong",null,"客户地址:",-1)),s(" "+r(i.deliveryInfo.dropoffAddress),1)]),o("p",null,[e[10]||(e[10]=o("strong",null,"预计送达:",-1)),s(" "+r(i.deliveryInfo.estimatedArrival==="ASAP"?"尽快送达":i.deliveryInfo.estimatedArrival),1)]),o("p",null,[e[11]||(e[11]=o("strong",null,"配送费用:",-1)),s(" $"+r((i.deliveryInfo.totalFee/100).toFixed(2)),1)])]),o("div",N,[a(y,{type:"primary",block:"",onClick:d.openConfirmDialog},{default:v(()=>e[12]||(e[12]=[s("确认接单")])),_:1},8,["onClick"])])])):g("",!0),i.orderStatus==="IN_DELIVERY"?(f(),u("div",T,[i.deliveryInfo.driverDirection==="HEADING_TO_MERCHANT"?(f(),u("div",G,[o("div",M,[o("p",null,[e[13]||(e[13]=o("strong",null,"配送订单号:",-1)),s(" "+r(i.deliveryId),1)]),o("p",null,[e[14]||(e[14]=o("strong",null,"商家地址: ",-1)),o("a",{href:d.getNavigationUrl(i.deliveryInfo.pickupLocation),target:"_blank",class:"clickable"},r(i.deliveryInfo.pickupAddress),9,x)]),o("p",null,[e[15]||(e[15]=o("strong",null,"商家电话: ",-1)),o("a",{href:"tel:"+i.deliveryInfo.pickupPhone,class:"clickable"},r(i.deliveryInfo.pickupPhone||"无"),9,O)]),o("p",null,[e[16]||(e[16]=o("strong",null,"商家备注: ",-1)),s(" "+r(i.deliveryInfo.pickupRemark||"无"),1)]),o("p",null,[e[17]||(e[17]=o("strong",null,"客户地址: ",-1)),e[18]||(e[18]=s()),o("a",{href:d.getNavigationUrl(i.deliveryInfo.dropoffLocation),target:"_blank",class:"clickable"},r(i.deliveryInfo.dropoffAddress),9,H)]),o("p",null,[e[19]||(e[19]=o("strong",null,"客人电话: ",-1)),o("a",{href:"tel:"+i.deliveryInfo.dropoffPhone,class:"clickable"},r(i.deliveryInfo.dropoffPhone||"无"),9,q)]),o("p",null,[e[20]||(e[20]=o("strong",null,"客户备注: ",-1)),s(" "+r(i.deliveryInfo.dropoffRemark||"无"),1)]),o("p",null,[e[21]||(e[21]=o("strong",null,"配送费用: ",-1)),s(" $"+r((i.deliveryInfo.totalFee/100).toFixed(2)),1)])]),o("div",B,[a(y,{color:"#f09e08",block:"",onClick:d.openPickupDialog},{default:v(()=>e[22]||(e[22]=[s("已领取商品")])),_:1},8,["onClick"])])])):g("",!0),i.deliveryInfo.driverDirection==="HEADING_TO_CUSTOMER"?(f(),u("div",W,[o("div",Y,[o("p",null,[e[23]||(e[23]=o("strong",null,"配送订单号: ",-1)),s(" "+r(i.deliveryId),1)]),o("p",null,[e[24]||(e[24]=o("strong",null,"商家地址: ",-1)),o("a",{href:d.getNavigationUrl(i.deliveryInfo.pickupLocation),target:"_blank",class:"clickable"},r(i.deliveryInfo.pickupAddress),9,z)]),o("p",null,[e[25]||(e[25]=o("strong",null,"商家电话: ",-1)),o("a",{href:"tel:"+i.deliveryInfo.pickupPhone,class:"clickable"},r(i.deliveryInfo.pickupPhone||"无"),9,K)]),o("p",null,[e[26]||(e[26]=o("strong",null,"商家备注: ",-1)),s(" "+r(i.deliveryInfo.pickupRemark||"无"),1)]),o("p",null,[e[27]||(e[27]=o("strong",null,"客户地址: ",-1)),e[28]||(e[28]=s()),o("a",{href:d.getNavigationUrl(i.deliveryInfo.dropoffLocation),target:"_blank",class:"clickable"},r(i.deliveryInfo.dropoffAddress),9,j)]),o("p",null,[e[29]||(e[29]=o("strong",null,"客人电话: ",-1)),o("a",{href:"tel:"+i.deliveryInfo.dropoffPhone,class:"clickable"},r(i.deliveryInfo.dropoffPhone||"无"),9,J)]),o("p",null,[e[30]||(e[30]=o("strong",null,"客户备注: ",-1)),s(" "+r(i.deliveryInfo.dropoffRemark||"无"),1)]),o("p",null,[e[31]||(e[31]=o("strong",null,"配送费用: ",-1)),s(" $"+r((i.deliveryInfo.totalFee/100).toFixed(2)),1)])]),o("div",Q,[a(y,{color:"#5ac7a0",block:"",onClick:d.openDropoffDialog},{default:v(()=>e[32]||(e[32]=[s("已送达商品")])),_:1},8,["onClick"])])])):g("",!0)])):g("",!0),i.orderStatus==="FINISH"?(f(),u("div",X,[o("div",Z,[a(D,{name:"passed",class:"success-icon"}),e[35]||(e[35]=o("h2",{class:"success-word"},"配送完成",-1)),o("p",null,[e[33]||(e[33]=o("strong",null,"配送订单号:",-1)),s(" "+r(i.deliveryId),1)]),o("p",null,[e[34]||(e[34]=o("strong",null,"配送费用:",-1)),s(" $"+r((i.deliveryInfo.totalFee/100).toFixed(2)),1)])])])):g("",!0)])]),a(k,{show:i.showConfirmDialog,"onUpdate:show":e[2]||(e[2]=l=>i.showConfirmDialog=l),title:"确认接单","show-cancel-button":"",onConfirm:d.confirmOrder},{default:v(()=>[a(w,{modelValue:i.formData.name,"onUpdate:modelValue":e[0]||(e[0]=l=>i.formData.name=l),label:"姓名",placeholder:"请输入英文姓名",required:""},null,8,["modelValue"]),a(w,{modelValue:i.formData.phone,"onUpdate:modelValue":e[1]||(e[1]=l=>i.formData.phone=l),label:"手机号",placeholder:"请输入手机号",required:"",type:"tel"},null,8,["modelValue"])]),_:1},8,["show","onConfirm"]),a(k,{show:i.showPickupDialog,"onUpdate:show":e[4]||(e[4]=l=>i.showPickupDialog=l),title:"确认领取商品","show-cancel-button":"","confirm-button-disabled":i.uploading,onConfirm:d.confirmPickup},{default:v(()=>[o("div",$,[e[36]||(e[36]=o("p",null,"请上传商品图片",-1)),o("div",ee,[a(b,{"after-read":d.onUpload,name:"file","max-count":"1",accept:"image/*",modelValue:i.previewImages,"onUpdate:modelValue":e[3]||(e[3]=l=>i.previewImages=l)},null,8,["after-read","modelValue"])])])]),_:1},8,["show","confirm-button-disabled","onConfirm"]),a(k,{show:i.showDropoffDialog,"onUpdate:show":e[6]||(e[6]=l=>i.showDropoffDialog=l),title:"确认送达商品","show-cancel-button":"","confirm-button-disabled":i.uploading,onConfirm:d.confirmDropoff},{default:v(()=>[o("div",oe,[e[37]||(e[37]=o("p",null,"请上传商品图片（确保已经电话联系客人并且客人可以找到的位置）",-1)),o("div",te,[a(b,{"after-read":d.onUpload,name:"file","max-count":"1",accept:"image/*",modelValue:i.previewImages,"onUpdate:modelValue":e[5]||(e[5]=l=>i.previewImages=l)},null,8,["after-read","modelValue"])])])]),_:1},8,["show","confirm-button-disabled","onConfirm"])])])}const ne=L(C,[["render",ie],["__scopeId","data-v-89ca01b7"]]);export{ne as default};
