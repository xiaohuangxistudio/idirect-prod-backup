import{_ as Y,x as V,s as B,m as G,h as I,q as S,A as H,c as i,a as y,b as s,F as b,f as a,t as m,g as E,w as u,d as h,e as W,r as L,o,v as z}from"./index-Cm55Gr8Q.js";const U={data(){return{map:null,markersArray:[],bounds:null,pickupLatLng:"",dropoffLatLng:"",isMapUpdated:!1,driver:{name:"",phone:"",latitude:null,longitude:null,direction:"ALL"},order:{deliveryId:"",pickupAddress:"",dropoffAddress:"",status:"LOADING",statusMessage:"",estimatedArrival:"",totalFee:0,paymentLink:"",createAt:"",expireAt:"",proofOfDelivery:[]},priceInfo:[],currentStep:0,countdown:10,showLoading:null}},mounted(){this.initMap(),this.showLoading=V({message:"加载中...",forbidClick:!0}),this.fetchOrderTrackingDetails(),this.startPolling()},beforeUnmount(){this.clearPolling()},methods:{goBack(){this.$router.push("/merchant/order")},copyText(r){navigator.clipboard.writeText(r).then(()=>{B("复制成功")}).catch(()=>{B("复制失败")})},initMap(){const r=[{featureType:"all",elementType:"all",stylers:[{hue:"#ff0000"}]},{featureType:"all",elementType:"geometry",stylers:[{color:"#ffffff"}]},{featureType:"all",elementType:"geometry.fill",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"all",elementType:"geometry.stroke",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"all",elementType:"labels",stylers:[{saturation:"0"}]},{featureType:"all",elementType:"labels.text.fill",stylers:[{color:"#7a8487"},{saturation:"0"}]},{featureType:"all",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"all",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#535e61"},{saturation:"0"}]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"administrative",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"administrative.country",elementType:"labels",stylers:[{saturation:"0"}]},{featureType:"administrative.country",elementType:"labels.text.fill",stylers:[{color:"#535e61"},{saturation:"0"}]},{featureType:"administrative.country",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"administrative.province",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"administrative.province",elementType:"labels.text.fill",stylers:[{color:"#535e61"}]},{featureType:"administrative.province",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"administrative.locality",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"administrative.neighborhood",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"administrative.land_parcel",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#edf1f2"},{saturation:"0"}]},{featureType:"landscape",elementType:"labels.text.fill",stylers:[{color:"#535e61"},{saturation:"0"}]},{featureType:"landscape",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"landscape.natural",elementType:"geometry.fill",stylers:[{saturation:"0"}]},{featureType:"landscape.natural",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{saturation:"0"}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#7a8487"},{saturation:"0"}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.highway",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#7a8487"},{saturation:"0"}]},{featureType:"road.local",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{saturation:"0"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#7a8487"},{visibility:"on"}]},{featureType:"water",elementType:"geometry.fill",stylers:[{color:"#9ba5a8"},{saturation:"0"}]},{featureType:"water",elementType:"labels",stylers:[{visibility:"off"}]}];this.map=new google.maps.Map(document.getElementById("map"),{center:{lat:-33.8688,lng:151.2093},zoom:17,disableDefaultUI:!0,mapTypeControl:!1,fullscreenControl:!1,styles:r}),this.bounds=new google.maps.LatLngBounds},clearOverlays(){console.log("this.markersArray"),console.log(this.markersArray.length);for(let r=0;r<this.markersArray.length;r++)this.markersArray[r].setVisible(!1);this.markersArray=[],console.log("All markers removed from map")},updateBounds(){this.bounds?this.bounds=new google.maps.LatLngBounds:this.bounds=new google.maps.LatLngBounds,this.driver.direction==="HEADING_TO_MERCHANT"?this.markersArray.forEach(r=>{(r.markerType==="PICKUP"||r.markerType==="DRIVER")&&this.bounds.extend(r.getPosition())}):this.driver.direction==="HEADING_TO_CUSTOMER"?this.markersArray.forEach(r=>{(r.markerType==="DROPOFF"||r.markerType==="DRIVER")&&this.bounds.extend(r.getPosition())}):this.markersArray.forEach(r=>{r.getVisible()&&this.bounds.extend(r.getPosition())}),this.bounds.isEmpty()?console.log("No markers visible, bounds not updated"):(this.map.fitBounds(this.bounds),console.log("Bounds updated"))},async fetchOrderTrackingDetails(){var r,e,n,d,t,c,T,v,_,g,A,p,k,w,C,N,x,O,R;try{const D=this.$route.query.deliveryId,P=await G.get("/api/merchant/trackOrder",{params:{deliveryId:D}});if(P.data.code===200){const l=P.data.data;this.order.status=((r=l.orderInfo)==null?void 0:r.status)||"",this.order.deliveryId=(l==null?void 0:l.deliveryId)||"",this.order.estimatedArrival=((e=l.orderInfo)==null?void 0:e.estimatedArrival)||"",this.order.pickupAddress=((n=l.orderInfo)==null?void 0:n.pickupAddress)||"暂无地址",this.order.dropoffAddress=((d=l.orderInfo)==null?void 0:d.dropoffAddress)||"暂无地址",this.order.totalFee=((t=l.orderInfo)==null?void 0:t.totalFee)||0,this.order.paymentLink=((c=l.orderInfo)==null?void 0:c.paymentLink)||"",this.currentStep=this.getStepFromStatus(this.order.status),this.priceInfo=l.priceInfo||[],(T=l.orderInfo)!=null&&T.proofOfDelivery?this.order.proofOfDelivery=Object.values(l.orderInfo.proofOfDelivery):this.order.proofOfDelivery=[];const F=((v=l.orderInfo)==null?void 0:v.createAt)||null;if(F){const f=new Date(F*1e3);this.order.createAt=`${f.getFullYear()}年${(f.getMonth()+1).toString().padStart(2,"0")}月${f.getDate().toString().padStart(2,"0")}日 ${f.getHours().toString().padStart(2,"0")}时${f.getMinutes().toString().padStart(2,"0")}分${f.getSeconds().toString().padStart(2,"0")}秒`}else this.order.createAt="未知";const M=((_=l.orderInfo)==null?void 0:_.expireAt)||null;if(M){const f=new Date(M*1e3);this.order.expireAt=`${f.getFullYear()}年${(f.getMonth()+1).toString().padStart(2,"0")}月${f.getDate().toString().padStart(2,"0")}日 ${f.getHours().toString().padStart(2,"0")}时${f.getMinutes().toString().padStart(2,"0")}分${f.getSeconds().toString().padStart(2,"0")}秒`}else this.order.expireAt="未知";this.clearOverlays(),(A=(g=l.orderInfo)==null?void 0:g.pickupLocation)!=null&&A.lat&&((k=(p=l.orderInfo)==null?void 0:p.pickupLocation)!=null&&k.lng)&&this.updatePickupLocation(l.orderInfo.pickupLocation.lat,l.orderInfo.pickupLocation.lng),(C=(w=l.orderInfo)==null?void 0:w.dropoffLocation)!=null&&C.lat&&((x=(N=l.orderInfo)==null?void 0:N.dropoffLocation)!=null&&x.lng)&&this.updateDropoffLocation(l.orderInfo.dropoffLocation.lat,l.orderInfo.dropoffLocation.lng),l.driverInfo&&this.order.status==="IN_DELIVERY"?(this.driver={name:l.driverInfo.name||"暂无",phone:l.driverInfo.phone||"暂无",latitude:parseFloat(((O=l.driverInfo.location)==null?void 0:O.lat)||0),longitude:parseFloat(((R=l.driverInfo.location)==null?void 0:R.lng)||0),direction:l.driverInfo.direction||"ALL"},this.driver.latitude&&this.driver.longitude&&this.updateDriverLocation(this.driver.latitude,this.driver.longitude)):this.driver={name:"",phone:"",latitude:null,longitude:null},this.showLoading&&this.showLoading.close()}else this.showLoading&&this.showLoading.close(),I("订单不存在"),setTimeout(()=>{this.$router.push("/merchant/order")},2e3)}catch(D){this.showLoading&&this.showLoading.close(),console.error("Error fetching order tracking details:",D)}},getStepFromStatus(r){switch(r){case"WAITING_REVIEW":return 0;case"REVIEW_SUCCESS":return 1;case"IN_DELIVERY":return 2;case"FINISH":return 3;case"CANCEL":return 0;default:return 0}},updatePickupLocation(r,e){const n=new google.maps.LatLng(r,e),d=new google.maps.Marker({map:this.map,position:n,icon:{url:"https://delivery-static-file.idirect.au/asset/icon/merchant.svg",scaledSize:new google.maps.Size(32,32),anchor:new google.maps.Point(17.5,20)}});d.markerType="PICKUP",this.markersArray.push(d),this.updateBounds(),console.log("Pickup marker updated")},updateDropoffLocation(r,e){const n=new google.maps.LatLng(r,e),d=new google.maps.Marker({map:this.map,position:n,icon:{url:"https://delivery-static-file.idirect.au/asset/icon/customer.svg",scaledSize:new google.maps.Size(32,32),anchor:new google.maps.Point(17.5,20)}});d.markerType="DROPOFF",this.markersArray.push(d),this.updateBounds(),console.log("Dropoff marker updated")},updateDriverLocation(r,e){const n=new google.maps.LatLng(r,e),d=new google.maps.Marker({map:this.map,position:n,icon:{url:"https://delivery-static-file.idirect.au/asset/icon/driver.svg",scaledSize:new google.maps.Size(32,32),anchor:new google.maps.Point(17.5,20)}});d.markerType="DRIVER",this.markersArray.push(d),this.updateBounds(),console.log("Driver marker updated")},drawDrivingRoute(r,e){const n=new google.maps.DirectionsService,d=new google.maps.DirectionsRenderer({map:this.map,suppressMarkers:!0,polylineOptions:{strokeColor:"#363636",strokeOpacity:.8,strokeWeight:3}}),t={origin:r,destination:e,travelMode:google.maps.TravelMode.DRIVING};n.route(t,(c,T)=>{T===google.maps.DirectionsStatus.OK?(d.setDirections(c),this.map.fitBounds(this.bounds)):console.error("Directions request failed due to "+T)})},showDescribe(r){S({message:r})},startPolling(){this.intervalId=setInterval(()=>{this.fetchOrderTrackingDetails(),console.log("Launch pool refresh"),this.countdown=10},1e4),setInterval(()=>{this.countdown>0&&this.countdown--},1e3)},clearPolling(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)},payDeliveryFee(){window.location.href=this.order.paymentLink},async cancelOrder(){try{if(await S({title:"取消配送",message:"确定要取消配送单吗？",showCancelButton:!0,confirmButtonText:"确认",cancelButtonText:"取消"})){V({message:"取消中...",forbidClick:!0});const e=this.$route.query.deliveryId,n=await G.post("/api/merchant/cancelOrder",{deliveryId:e});n.data.code===200?(this.order.status="CANCEL",S({title:"取消成功",message:"配送单已成功取消"})):I(n.data.message||"配送单取消失败")}}catch(r){console.error("Error cancelling order:",r),I("服务器抽风了")}finally{this.showLoading&&this.showLoading.close()}},previewImage(r){H({images:this.order.proofOfDelivery,startPosition:r,closeable:!0})},callCourier(){this.driver.phone?window.open(`tel:${this.driver.phone}`):I("配送员电话不可用")},sendMessageCourier(){this.driver.phone?window.open(`sms:${this.driver.phone}`):I("无法发送消息给配送员")}}},q={class:"page"},K={class:"tracker-container"},j={class:"delivery-status-container"},J={key:0,class:"estimated-time"},Q={key:1,class:"estimated-time"},X={key:2,class:"estimated-time"},Z={key:3,class:"estimated-time"},$={key:4,class:"estimated-time"},ee={key:5,class:"estimated-time"},te={key:6,class:"estimated-time"},se={key:7,class:"estimated-time"},re={class:"status-text"},oe={key:0},ie={key:1},le={key:2},ae={key:3},ne={key:4},de={key:5},pe={key:6},ue={key:7},ce={class:"delivery-detail-container"},fe={class:"detail-item"},ye={class:"value"},me={class:"text"},ve={class:"detail-item"},he={class:"value"},ge={class:"detail-item"},Te={class:"value"},ke={class:"detail-item"},_e={class:"value"},Ie={key:0,class:"detail-item"},be={class:"value"},Le={class:"delivery-detail-container"},Ae={class:"label"},we={class:"total-fee"},De={key:0,class:"divider"},Se={key:1,class:"delivery-detail-container"},Ee={class:"detail-item"},Ce={class:"value"},Ne={class:"detail-item"},xe={class:"value"},Oe={class:"driver-contact-button"},Re={key:2,class:"divider"},Pe={key:3,class:"payment-button-container"},Fe={class:"driver-contact-button"},Me={key:4,class:"divider"},Ve={key:5,class:"delivery-detail-container"},Be={class:"proof-of-delivery-images"},Ge=["src","onClick"];function We(r,e,n,d,t,c){const T=L("van-nav-bar"),v=L("van-step"),_=L("van-steps"),g=L("van-button"),A=L("van-icon");return o(),i("div",q,[y(T,{title:"配送追踪","left-arrow":"",fixed:"",onClickLeft:c.goBack},null,8,["onClickLeft"]),s("div",K,[e[25]||(e[25]=s("div",{id:"map",class:"map-container"},null,-1)),s("div",j,[t.order.status==="LOADING"?(o(),i("h1",J,"加载中")):t.order.status==="WAITING_PAY"?(o(),i("h1",Q,"待支付配送费")):t.order.status==="WAITING_REVIEW"?(o(),i("h1",X,"配送信息审核中")):t.order.status==="REVIEW_SUCCESS"?(o(),i("h1",Z,"审核通过，匹配骑手中")):t.order.status==="IN_DELIVERY"?(o(),i("h1",$,[t.driver.direction==="HEADING_TO_MERCHANT"?(o(),i(b,{key:0},[a(" 配送员正在领取商品 ")],64)):t.driver.direction==="HEADING_TO_CUSTOMER"?(o(),i(b,{key:1},[a(" 配送员正在配送中 ")],64)):(o(),i(b,{key:2},[a(" 配送中，预计送达时间："+m(t.order.estimatedArrival||"尽快送达"),1)],64))])):t.order.status==="FINISH"?(o(),i("h1",ee,"订单已送达")):t.order.status==="CANCEL"?(o(),i("h1",te,"订单已取消")):(o(),i("h1",se,"状态未知")),s("p",re,[t.order.status==="LOADING"?(o(),i("span",oe,"加载中")):t.order.status==="WAITING_PAY"?(o(),i("span",ie,"如需现金支付请与我们联系（电话：0450363766）")):t.order.status==="WAITING_REVIEW"?(o(),i("span",le,"我们正在审核您提交的信息，"+m(t.countdown)+" 秒后自动刷新",1)):t.order.status==="REVIEW_SUCCESS"?(o(),i("span",ae,"您的订单信息已通过审核，正在为您匹配配送员")):t.order.status==="IN_DELIVERY"?(o(),i("span",ne,"您的订单正在配送途中（司机位置仅供参考）")):t.order.status==="FINISH"?(o(),i("span",de,"订单已完成，感谢您使用我们的配送服务")):t.order.status==="CANCEL"?(o(),i("span",pe,"很抱歉，订单已被取消")):(o(),i("span",ue,"状态未知"))]),t.order.status!=="CANCEL"?(o(),E(_,{key:8,active:t.currentStep,"active-icon":"success","active-color":"#07c160"},{default:u(()=>[y(v,null,{default:u(()=>e[1]||(e[1]=[a("提交申请")])),_:1}),y(v,null,{default:u(()=>e[2]||(e[2]=[a("审核完成")])),_:1}),y(v,null,{default:u(()=>e[3]||(e[3]=[a("配送中")])),_:1}),y(v,null,{default:u(()=>e[4]||(e[4]=[a("已完成")])),_:1})]),_:1},8,["active"])):h("",!0),t.order.status==="CANCEL"?(o(),E(_,{key:9,"active-icon":"fail","active-color":"#ee0a24",active:"2"},{default:u(()=>[y(v,null,{default:u(()=>e[5]||(e[5]=[a("提交申请")])),_:1}),y(v,null,{default:u(()=>e[6]||(e[6]=[a("审核完成")])),_:1}),y(v,null,{default:u(()=>e[7]||(e[7]=[a("已取消")])),_:1})]),_:1})):h("",!0)]),e[26]||(e[26]=s("div",{class:"divider"},null,-1)),s("div",ce,[e[14]||(e[14]=s("h3",null,"订单详情",-1)),s("div",fe,[e[9]||(e[9]=s("span",{class:"label"},"派送单号",-1)),s("span",ye,[s("span",me,m(t.order.deliveryId||"暂无单号"),1),y(g,{type:"primary",size:"mini",plain:"",class:"copy-button",onClick:e[0]||(e[0]=p=>c.copyText(t.order.deliveryId))},{default:u(()=>e[8]||(e[8]=[a(" 复制 ")])),_:1})])]),s("div",ve,[e[10]||(e[10]=s("span",{class:"label"},"取餐地址",-1)),s("span",he,m(t.order.pickupAddress||"暂无地址"),1)]),s("div",ge,[e[11]||(e[11]=s("span",{class:"label"},"送达地址",-1)),s("span",Te,m(t.order.dropoffAddress||"暂无地址"),1)]),s("div",ke,[e[12]||(e[12]=s("span",{class:"label"},"创建时间",-1)),s("span",_e,m(t.order.createAt||"未知"),1)]),t.order.status==="WAITING_PAY"?(o(),i("div",Ie,[e[13]||(e[13]=s("span",{class:"label"},"过期时间",-1)),s("span",be,m(t.order.expireAt||"未知"),1)])):h("",!0)]),e[27]||(e[27]=s("div",{class:"divider"},null,-1)),s("div",Le,[e[16]||(e[16]=s("h3",null,"费用详情",-1)),(o(!0),i(b,null,W(t.priceInfo,(p,k)=>(o(),i("div",{class:"detail-item",key:k},[s("span",Ae,[a(m(p.type)+" ",1),p.describe?(o(),E(A,{key:0,name:"question-o",size:"16px",class:"info-icon",onClick:w=>c.showDescribe(p.describe)},null,8,["onClick"])):h("",!0)]),s("div",{class:"fee-amount",style:z({color:p.amount<0?"rgb(242, 83, 83)":"#333"})},m(p.amount===0?"免费":p.amount<0?"-$"+Math.abs(p.amount/100).toFixed(2):"$"+(p.amount/100).toFixed(2)),5)]))),128)),s("div",we,[e[15]||(e[15]=s("strong",null,"总计：",-1)),s("span",null,m("$"+(t.order.totalFee/100).toFixed(2)),1)])]),t.order.status==="IN_DELIVERY"?(o(),i("div",De)):h("",!0),t.order.status==="IN_DELIVERY"?(o(),i("div",Se,[e[21]||(e[21]=s("h3",null,"配送详情",-1)),s("div",Ee,[e[17]||(e[17]=s("span",{class:"label"},"配送员",-1)),s("span",Ce,m(t.driver.name||"暂无"),1)]),s("div",Ne,[e[18]||(e[18]=s("span",{class:"label"},"手机号",-1)),s("span",xe,m(t.driver.phone||"暂无"),1)]),s("div",Oe,[y(g,{type:"primary",block:"",onClick:c.callCourier},{default:u(()=>e[19]||(e[19]=[a("给配送员打电话")])),_:1},8,["onClick"]),y(g,{type:"primary",block:"",onClick:c.sendMessageCourier},{default:u(()=>e[20]||(e[20]=[a("给配送员发短信")])),_:1},8,["onClick"])])])):h("",!0),t.order.status==="WAITING_PAY"?(o(),i("div",Re)):h("",!0),t.order.status==="WAITING_PAY"?(o(),i("div",Pe,[s("div",Fe,[y(g,{type:"primary",block:"",onClick:c.payDeliveryFee},{default:u(()=>e[22]||(e[22]=[a("支付配送费")])),_:1},8,["onClick"]),y(g,{type:"danger",block:"",onClick:c.cancelOrder},{default:u(()=>e[23]||(e[23]=[a("取消订单")])),_:1},8,["onClick"])])])):h("",!0),t.order.status==="IN_DELIVERY"||t.order.status==="FINISH"?(o(),i("div",Me)):h("",!0),t.order.proofOfDelivery.length>0?(o(),i("div",Ve,[e[24]||(e[24]=s("h3",null,"配送证明",-1)),s("div",Be,[(o(!0),i(b,null,W(t.order.proofOfDelivery,(p,k)=>(o(),i("img",{key:k,src:p,onClick:w=>c.previewImage(k),alt:"Proof of Delivery",class:"proof-image"},null,8,Ge))),128))])])):h("",!0)])])}const He=Y(U,[["render",We],["__scopeId","data-v-4443c8f3"]]);export{He as default};
